<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Leaderboard â€¢ Family</title>
  <link rel="stylesheet" href="./_shared.css"/>
  <script defer src="./config.js"></script>
  <script defer src="./_shared.js"></script>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="title"><span class="title-main">ðŸ“Š Leaderboard</span><span class="title-sub">See whoâ€™s reading</span></div>
    <div class="nav">
      <a href="./index.html">Reading</a>
      <a href="./homework.html">Homework</a>
      <a href="./parent.html">Parent</a>
      <a href="./leaderboard.html">Leaderboard</a>
    </div>
  </div>

  <div class="card">
    <div class="title" style="font-size:18px">ðŸ“ˆ Progress over the last 6 weeks</div>
    <div id="chartBoard" class="dashboard-grid chart-grid"></div>
    <div id="chartStatus" class="status"></div>
  </div>

  <div class="card">
    <div class="title" style="font-size:18px">ðŸ“… Pages per reader each week</div>
    <div id="weeklyBoard" class="dashboard-grid"></div>
    <div id="weeklyStatus" class="status"></div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  const { readingApiBase, children } = window.APP_CONFIG;
  const chartBoard = document.getElementById('chartBoard');
  const chartStatus = document.getElementById('chartStatus');
  const weeklyBoard = document.getElementById('weeklyBoard');
  const weeklyStatus = document.getElementById('weeklyStatus');

  chartStatus.textContent = 'Loading...';
  weeklyStatus.textContent = 'Loading...';

  try{
    const perChild = await Promise.all(children.map(async child => {
      const entries = await apiGET(readingApiBase, `/v1/children/${encodeURIComponent(child.id)}/entries?limit=200`);
      return entries.map(entry => ({ ...entry, child_id: entry.child_id || child.id }));
    }));
    const entries = perChild.flat();

    renderChildCharts(entries, children, chartBoard);
    renderWeeklyBoard(entries, children, weeklyBoard);

    if (!chartBoard.childElementCount) chartBoard.innerHTML = '<div class="hint">No reading activity yet.</div>';
    if (!weeklyBoard.childElementCount) weeklyBoard.innerHTML = '<div class="hint">No reading activity yet.</div>';

    chartStatus.textContent = '';
    weeklyStatus.textContent = '';
  }catch(e){
    const message = e?.message || 'Failed to load data.';
    chartStatus.textContent = message;
    chartStatus.classList.add('err');
    weeklyStatus.textContent = message;
    weeklyStatus.classList.add('err');
  }
});

function renderChildCharts(entries, children, container){
  const weeks = getRecentWeekStarts(6);
  const weekLabels = weeks.map(formatWeekShort);

  children.forEach(child => {
    const totals = weeks.map(() => 0);
    entries.forEach(entry => {
      if ((entry.child_id || child.id) !== child.id) return;
      const date = normaliseDate(entry);
      if (!date) return;
      const week = getWeekStart(date);
      const idx = weeks.indexOf(week);
      if (idx === -1) return;
      const pages = normalisePages(entry);
      totals[idx] += pages;
    });

    const maxPages = Math.max(...totals, 0);
    const chart = document.createElement('div');
    chart.className = 'stat-card chart-card';

    const header = document.createElement('div');
    header.className = 'stat-title';
    header.textContent = child.name;
    chart.appendChild(header);

    const bars = document.createElement('div');
    bars.className = 'chart-bars';

    totals.forEach((value, idx) => {
      const wrapper = document.createElement('div');
      wrapper.className = 'chart-bar-wrapper';

      const valueLabel = document.createElement('div');
      valueLabel.className = 'chart-value';
      valueLabel.textContent = value ? `${value} pages` : '';
      wrapper.appendChild(valueLabel);

      const bar = document.createElement('div');
      bar.className = 'chart-bar';
      const maxHeight = 120;
      const height = maxPages > 0 ? Math.round((value / maxPages) * maxHeight) : 0;
      bar.style.height = `${Math.max(value > 0 ? height : 4, 4)}px`;
      bar.classList.toggle('empty', value === 0);
      wrapper.appendChild(bar);

      const weekLabel = document.createElement('div');
      weekLabel.className = 'chart-week';
      weekLabel.textContent = weekLabels[idx];
      wrapper.appendChild(weekLabel);

      bars.appendChild(wrapper);
    });

    chart.appendChild(bars);
    container.appendChild(chart);
  });
}

function renderWeeklyBoard(entries, children, container){
  const weekly = new Map();
  entries.forEach(entry => {
    const date = normaliseDate(entry);
    if (!date) return;
    const pages = normalisePages(entry);
    if (!pages) return;
    const weekStart = getWeekStart(date);
    if (!weekly.has(weekStart)) weekly.set(weekStart, new Map());
    const map = weekly.get(weekStart);
    const childId = entry.child_id;
    map.set(childId, (map.get(childId) || 0) + pages);
  });

  const orderedWeeks = Array.from(weekly.keys()).sort((a,b) => b.localeCompare(a)).slice(0, 6);
  orderedWeeks.forEach(week => {
    const totals = weekly.get(week);
    const card = document.createElement('div');
    card.className = 'stat-card';
    const header = document.createElement('div');
    header.className = 'stat-title';
    header.textContent = formatWeekLabel(week);
    card.appendChild(header);

    const list = document.createElement('div');
    list.className = 'stat-list';
    const rows = children.map(child => ({
      id: child.id,
      name: child.name,
      pages: totals.get(child.id) || 0
    })).filter(row => row.pages > 0)
      .sort((a,b) => b.pages - a.pages || a.name.localeCompare(b.name));

    if (!rows.length){
      const empty = document.createElement('div');
      empty.className = 'hint';
      empty.textContent = 'No pages this week.';
      list.appendChild(empty);
    }else{
      rows.forEach(row => {
        const item = document.createElement('div');
        item.className = 'stat-row';
        const name = document.createElement('span');
        name.textContent = row.name;
        const value = document.createElement('span');
        value.className = 'stat-value';
        value.textContent = `${row.pages} pages`;
        item.appendChild(name);
        item.appendChild(value);
        list.appendChild(item);
      });
    }
    card.appendChild(list);
    container.appendChild(card);
  });
}

function normaliseDate(entry){
  if (entry.date && /^\d{4}-\d{2}-\d{2}$/.test(entry.date)) return entry.date;
  if (entry.created_at) {
    const ms = Number(entry.created_at);
    if (!Number.isNaN(ms)) return new Date(ms).toISOString().slice(0,10);
  }
  return null;
}

function normalisePages(entry){
  const raw = entry.pages ?? entry.pages_read ?? 0;
  const num = Number(raw);
  return Number.isFinite(num) && num > 0 ? Math.round(num) : 0;
}

function getWeekStart(dateStr){
  const [Y,M,D] = dateStr.split('-').map(Number);
  const dt = new Date(Date.UTC(Y, M - 1, D));
  const day = dt.getUTCDay(); // 0 (Sun) - 6 (Sat)
  const diff = (day + 6) % 7; // days since Monday
  dt.setUTCDate(dt.getUTCDate() - diff);
  return dt.toISOString().slice(0,10);
}

function getRecentWeekStarts(count){
  const today = new Date();
  const todayYMD = today.toISOString().slice(0,10);
  let cursor = new Date(getWeekStart(todayYMD) + 'T00:00:00Z');
  const out = [];
  for (let i = 0; i < count; i++){
    out.push(cursor.toISOString().slice(0,10));
    cursor.setUTCDate(cursor.getUTCDate() - 7);
  }
  return out.reverse();
}

function formatWeekLabel(weekStart){
  const start = new Date(weekStart + 'T00:00:00Z');
  const end = new Date(start);
  end.setUTCDate(end.getUTCDate() + 6);
  const startLabel = start.toLocaleDateString(undefined, { month:'short', day:'numeric' });
  const endLabel = end.toLocaleDateString(undefined, { month:'short', day:'numeric' });
  return `Week of ${startLabel} â€“ ${endLabel}`;
}

function formatWeekShort(weekStart){
  const start = new Date(weekStart + 'T00:00:00Z');
  return start.toLocaleDateString(undefined, { month:'short', day:'numeric' });
}
</script>
</body>
</html>
